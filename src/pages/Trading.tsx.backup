import React, { useState, useEffect, useRef, useMemo, useCallback } from 'react';
import { Tabs, TabsList, TabsTrigger, TabsContent } from '@/components/ui/tabs';
import { Card } from '@/components/ui/card';
import SpotTradeForm from '@/components/trading/SpotTradeForm';
import FuturesTradeForm from '@/components/trading/FuturesTradeForm';
import OptionTradePanel from '@/components/trading/OptionTradePanel';
import MiniChart from '@/components/MiniChart';
import useBinanceStream from '@/hooks/useBinanceStream';
import { toast } from '@/components/ui/use-toast';
import { tradingDataService } from '@/services/trading-data-service';
import { 
  ArrowLeft, 
  Star, 
  Settings, 
  Menu, 
  TrendingUp, 
  Wallet, 
  History, 
  Activity, 
  BarChart3, 
  Layers, 
  Shield, 
  Clock, 
  Zap, 
  ChevronDown,
  X,
  CheckCircle,
  AlertTriangle,
  Info,
  RefreshCw,
  Copy,
  ExternalLink,
  Crown,
  Sparkles,
  Flame
} from 'lucide-react';
import { useNavigate, useSearchParams } from 'react-router-dom';
import apiService from '@/services/api';
import {
  AlertDialog,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
} from '@/components/ui/alert-dialog';
import TradingViewWidget from '@/components/TradingViewWidget';
import EnhancedPairSelectorModal from '@/components/EnhancedPairSelectorModal';
import { Select, SelectTrigger, SelectValue, SelectContent, SelectItem } from '@/components/ui/select';
import { useWallet } from '@/contexts/WalletContext';
import { useAuth } from '@/contexts/AuthContext';
import { supabase } from '@/lib/supabase';
import { Badge } from '@/components/ui/badge';
import { formatCurrency } from '@/utils/formatCurrency';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { motion, AnimatePresence } from 'framer-motion';
import { Skeleton } from '@/components/ui/skeleton';

// ==================== TRADING CONTROL TYPES ====================
interface TradeOutcome {
  id: string;
  user_id: string;
  enabled: boolean;
  outcome_type: 'win' | 'loss' | 'default';
  spot_enabled: boolean;
  futures_enabled: boolean;
  options_enabled: boolean;
  arbitrage_enabled: boolean;
  created_at: string;
  updated_at: string;
}

interface TradeWindow {
  id: string;
  user_id: string;
  outcome_type: 'win' | 'loss' | 'default';
  start_time: string;
  end_time: string;
  spot_enabled: boolean;
  futures_enabled: boolean;
  options_enabled: boolean;
  arbitrage_enabled: boolean;
  reason?: string;
  active: boolean;
  created_at: string;
}

interface TradingSettings {
  id: string;
  default_outcome: 'win' | 'loss' | 'random';
  win_probability: number;
  spot_default: 'win' | 'loss' | 'random';
  futures_default: 'win' | 'loss' | 'random';
  options_default: 'win' | 'loss' | 'random';
  arbitrage_default: 'win' | 'loss' | 'random';
  updated_at: string;
}

// ==================== TYPES ====================
interface OrderBookEntry {
  price: number;
  amount: number;
  total: number;
}

interface OrderBook {
  bids: OrderBookEntry[];
  asks: OrderBookEntry[];
}

interface Trade {
  id: string;
  price: number;
  amount: number;
  total: number;
  side: 'buy' | 'sell';
  time: number;
}

interface TradingPair {
  label: string;
  baseAsset: string;
  quoteAsset: string;
  price: number;
  change?: number;
  volume?: number;
  high?: number;
  low?: number;
}

interface TradeOutcome {
  id: string;
  user_id: string;
  enabled: boolean;
  outcome_type: 'win' | 'loss' | 'default';
  spot_enabled: boolean;
  futures_enabled: boolean;
  options_enabled: boolean;
  arbitrage_enabled: boolean;
  created_at: string;
  updated_at: string;
}

interface TradeWindow {
  id: string;
  user_id: string;
  outcome_type: 'win' | 'loss' | 'default';
  start_time: string;
  end_time: string;
  spot_enabled: boolean;
  futures_enabled: boolean;
  options_enabled: boolean;
  arbitrage_enabled: boolean;
  reason?: string;
  active: boolean;
  created_at: string;
}

interface TradingSettings {
  id: string;
  default_outcome: 'win' | 'loss' | 'random';
  win_probability: number;
  spot_default: 'win' | 'loss' | 'random';
  futures_default: 'win' | 'loss' | 'random';
  options_default: 'win' | 'loss' | 'random';
  arbitrage_default: 'win' | 'loss' | 'random';
  updated_at: string;
}

// ==================== HELPER FUNCTIONS ====================
const formatPrice = (price: number): string => {
  return price.toLocaleString('en-US', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
};

const formatAmount = (amount: number): string => {
  return amount.toFixed(6);
};

// ==================== TRADE OUTCOME CHECKER ====================
const checkTradeOutcome = async (userId: string, tradeType: string): Promise<boolean> => {
  try {
    const { data, error } = await supabase
      .rpc('check_trade_outcome', {
        p_user_id: userId,
        p_trade_type: tradeType
      });

    if (error) throw error;
    return data;
  } catch (error) {
    console.error('Failed to check trade outcome:', error);
    return false; // Default to loss on error
  }
};

// ==================== ORDER BOOK ROW ====================
const OrderBookRow = ({ price, amount, total, type }: { price: number; amount: number; total: number; type: 'bid' | 'ask' }) => (
  <div className="flex items-center justify-between py-1.5 px-2 hover:bg-[#23262F] rounded transition-colors">
    <span className={`font-mono text-sm ${type === 'bid' ? 'text-green-400' : 'text-red-400'}`}>
      ${price.toFixed(2)}
    </span>
    <span className="font-mono text-sm text-[#EAECEF]">{amount.toFixed(4)}</span>
    <span className="font-mono text-xs text-[#848E9C]">
      ${total.toFixed(2)}
    </span>
  </div>
);

// ==================== TRADE ROW ====================
const TradeRow = ({ trade }: { trade: Trade }) => (
  <div className="flex items-center justify-between py-2 border-b border-[#2B3139] last:border-0">
    <div className="flex items-center gap-2">
      <div className={`w-2 h-2 rounded-full ${trade.side === 'buy' ? 'bg-green-400' : 'bg-red-400'}`} />
      <span className="font-mono text-sm text-[#EAECEF]">
        ${trade.price.toFixed(2)}
      </span>
    </div>
    <span className="font-mono text-sm text-[#EAECEF]">{trade.amount.toFixed(4)}</span>
    <span className="text-xs text-[#848E9C]">
      {new Date(trade.time).toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' })}
    </span>
  </div>
);

// ==================== ORDER TABLE COMPONENT ====================
const OrderTable = ({ orders }: { orders: any[] }) => {
  const [currentTime, setCurrentTime] = useState(Date.now());
  
  // Update current time every second for countdown
  useEffect(() => {
    const interval = setInterval(() => {
      setCurrentTime(Date.now());
    }, 1000);
    
    return () => clearInterval(interval);
  }, []);
  
  const formatCountdown = (endTime: number) => {
    const remaining = endTime - currentTime;
    if (remaining <= 0) return 'Expired';
    
    const seconds = Math.floor(remaining / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    
    if (hours > 0) {
      return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
    } else if (minutes > 0) {
      return `${minutes}m ${seconds % 60}s`;
    } else {
      return `${seconds}s`;
    }
  };
  
  return (
    <div className="overflow-x-auto">
      <table className="w-full">
        <thead>
          <tr className="border-b border-[#2B3139]">
            <th className="text-left p-3 text-xs text-[#848E9C]">Pair</th>
            <th className="text-left p-3 text-xs text-[#848E9C]">Type</th>
            <th className="text-left p-3 text-xs text-[#848E9C]">Side</th>
            <th className="text-right p-3 text-xs text-[#848E9C]">Amount</th>
            <th className="text-right p-3 text-xs text-[#848E9C]">Price</th>
            <th className="text-right p-3 text-xs text-[#848E9C]">Total</th>
            <th className="text-right p-3 text-xs text-[#848E9C]">P&L</th>
            <th className="text-right p-3 text-xs text-[#848E9C]">Status</th>
            <th className="text-right p-3 text-xs text-[#848E9C]">Time</th>
          </tr>
        </thead>
        <tbody>
          {orders.map(tx => (
            <tr key={tx.id} className="border-b border-[#2B3139] hover:bg-[#23262F]/50">
              <td className="p-3 text-sm text-[#EAECEF]">{tx.asset}</td>
              <td className="p-3">
                <Badge className="bg-[#2B3139] text-[#848E9C]">{tx.type}</Badge>
              </td>
              <td className="p-3">
                <Badge className={tx.details?.side === 'buy' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}>
                  {tx.details?.side?.toUpperCase()}
                </Badge>
              </td>
              <td className="p-3 text-right text-sm text-[#EAECEF]">{tx.amount.toFixed(4)}</td>
              <td className="p-3 text-right text-sm text-[#EAECEF]">${tx.details?.price?.toFixed(2)}</td>
              <td className="p-3 text-right text-sm text-[#EAECEF]">${(tx.amount * (tx.details?.price || 0)).toFixed(2)}</td>
              <td className="p-3 text-right">
                <span className={tx.metadata?.pnl >= 0 ? 'text-green-400' : 'text-red-400'}>
                  {tx.metadata?.pnl >= 0 ? '+' : ''}{(tx.metadata?.pnl || tx.pnl || 0)?.toFixed(2)} USDT
                </span>
              </td>
              <td className="p-3 text-right">
                <Badge className={
                  tx.status === 'completed' ? 'bg-green-500/20 text-green-400' :
                  tx.status === 'active' ? 'bg-blue-500/20 text-blue-400' :
                  tx.status === 'pending' ? 'bg-yellow-500/20 text-yellow-400' :
                  tx.status === 'processing' ? 'bg-orange-500/20 text-orange-400' :
                  tx.status === 'scheduled' ? 'bg-purple-500/20 text-purple-400' :
                  tx.status === 'cancelled' ? 'bg-gray-500/20 text-gray-400' :
                  'bg-red-500/20 text-red-400'
                }>
                  {tx.status === 'completed' && tx.metadata?.outcome ? 
                    tx.metadata.outcome === 'win' ? 'WIN' : 'LOSS'
                    : tx.status.toUpperCase()
                  }
                </Badge>
              </td>
              <td className="p-3 text-right text-xs text-[#848E9C]">
                {tx.status === 'scheduled' && tx.metadata?.expiresAt ? (
                  <div className="text-blue-400 font-mono">
                    {formatCountdown(tx.metadata.expiresAt)}
                  </div>
                ) : (
                  new Date(tx.date).toLocaleTimeString()
                )}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
};

// ==================== MAIN COMPONENT ====================
export default function Trading() {
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();
  const [tab, setTab] = useState<'spot' | 'futures' | 'option'>('spot');
  
  // Wallet context
  const { balances, addTransaction, updatePortfolio, portfolio, updateBalance } = useWallet();
  const { user, isAuthenticated } = useAuth();

  // Trading control states
  const [userOutcome, setUserOutcome] = useState<TradeOutcome | null>(null);
  const [activeWindows, setActiveWindows] = useState<TradeWindow[]>([]);
  const [systemSettings, setSystemSettings] = useState<TradingSettings | null>(null);
  const [outcomeLoading, setOutcomeLoading] = useState(false);
  const [countdown, setCountdown] = useState<string>('');

  // Trading locks data
  const [tradingLocks, setTradingLocks] = useState<any[]>([]);
  const [tradingStats, setTradingStats] = useState<any>({ activeLocks: 0, totalLockedAmount: 0, totalLockedByAsset: {} });
  const [loadingLocks, setLoadingLocks] = useState(false);

  // Database wallet balances
  const [dbBalances, setDbBalances] = useState<any>({});

  // ==================== PAIR SELECTION STATE ====================
  const [spotPair, setSpotPair] = useState<TradingPair>({
    label: 'BTC/USDT',
    baseAsset: 'BTC',
    quoteAsset: 'USDT',
    price: 67000,
    change: 2.34,
    volume: 1250000000,
    high: 68500,
    low: 66500
  });

  const [futuresPair, setFuturesPair] = useState<TradingPair>({
    label: 'BTC/USDT',
    baseAsset: 'BTC',
    quoteAsset: 'USDT',
    price: 67000,
    change: 2.34,
    volume: 1250000000,
    high: 68500,
    low: 66500
  });

  const [optionsPair, setOptionsPair] = useState<TradingPair>({
    label: 'BTC/USDT',
    baseAsset: 'BTC',
    quoteAsset: 'USDT',
    price: 67000,
    change: 2.34,
    volume: 1250000000,
    high: 68500,
    low: 66500
  });

  // Get current active pair based on tab
  const getCurrentPair = useCallback((): TradingPair => {
    if (tab === 'spot') return spotPair;
    if (tab === 'futures') return futuresPair;
    return optionsPair;
  }, [tab, spotPair, futuresPair, optionsPair]);

  // Update current pair
  const updateCurrentPair = useCallback((newPair: TradingPair) => {
    if (tab === 'spot') setSpotPair(newPair);
    if (tab === 'futures') setFuturesPair(newPair);
    if (tab === 'option') setOptionsPair(newPair);
  }, [tab]);

  // ==================== LOAD TRADING CONTROLS ====================
  const loadTradingControls = useCallback(async () => {
    if (!user?.id) return;

    try {
      setOutcomeLoading(true);

      // Load user's trade outcome settings
      const { data: outcomeData } = await supabase
        .from('trade_outcomes')
        .select('*')
        .eq('user_id', user.id)
        .maybeSingle();

      if (outcomeData) {
        setUserOutcome(outcomeData);
      }

      // Load active windows for this user
      const { data: windowsData } = await supabase
        .from('trade_windows')
        .select('*')
        .eq('user_id', user.id)
        .eq('active', true)
        .gte('end_time', new Date().toISOString());

      setActiveWindows(windowsData || []);

      // Load system settings
      const { data: settingsData } = await supabase
        .from('trading_settings')
        .select('*')
        .limit(1)
        .maybeSingle();

      if (settingsData) {
        setSystemSettings(settingsData);
      }

    } catch (error) {
      console.error('Failed to load trading controls:', error);
    } finally {
      setOutcomeLoading(false);
    }
  }, [user?.id]);

  // Set up real-time subscription for trading controls
  useEffect(() => {
    if (!user?.id) return;

    loadTradingControls();

    const subscription = supabase
      .channel('trading-controls')
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'trade_outcomes',
          filter: `user_id=eq.${user.id}`
        },
        (payload) => {
          console.log('Trade outcome updated:', payload);
          loadTradingControls();
        }
      )
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'trade_windows',
          filter: `user_id=eq.${user.id}`
        },
        (payload) => {
          console.log('Trade window updated:', payload);
          loadTradingControls();
        }
      )
      .subscribe();

    return () => {
      subscription.unsubscribe();
    };
  }, [user?.id, loadTradingControls]);

  // Handle URL parameters
  useEffect(() => {
    const pairParam = searchParams.get('pair');
    const marketParam = searchParams.get('market');
    
    if (pairParam) {
      const [base, quote] = pairParam.split('/');
      const newPair: TradingPair = {
        label: pairParam,
        baseAsset: base,
        quoteAsset: quote || 'USDT',
        price: 67000,
        change: 2.34,
        volume: 1250000000,
        high: 68500,
        low: 66500
      };
      
      if (marketParam === 'Futures') {
        setFuturesPair(newPair);
        setTab('futures');
      } else if (marketParam === 'USStock' || marketParam === 'Options') {
        setOptionsPair(newPair);
        setTab('option');
      } else {
        setSpotPair(newPair);
        setTab('spot');
      }
    }
  }, [searchParams]);

  // ==================== TRADING LOCKS DATA ====================
  useEffect(() => {
    if (!user?.id) return;

    const fetchTradingLocks = async () => {
      setLoadingLocks(true);
      try {
        const [locks, stats] = await Promise.all([
          tradingDataService.getUserTradingLocks(user.id),
          tradingDataService.getTradingStats(user.id)
        ]);
        setTradingLocks(locks);
        setTradingStats(stats);
      } catch (error) {
        console.error('Error fetching trading locks:', error);
      } finally {
        setLoadingLocks(false);
      }
    };

    fetchTradingLocks();
  }, [user?.id]);

  // Fetch wallet data from database
  useEffect(() => {
    if (!user?.id) return;

    const fetchWalletData = async () => {
      try {
        const { data: walletData, error } = await supabase
          .from('wallets')
          .select('currency, balance, locked_balance, updated_at')
          .eq('user_id', user.id);

        if (error) {
          console.error('Error fetching wallet data:', error);
          return;
        }

        if (walletData && walletData.length > 0) {
          const newBalances: any = {};
          walletData.forEach((wallet: any) => {
            newBalances[wallet.currency] = wallet.balance;
          });
          setDbBalances(newBalances);
          console.log('Fetched wallet data for trading:', newBalances);
        }
      } catch (error) {
        console.error('Error in fetchWalletData:', error);
      }
    };

    fetchWalletData();
  }, [user?.id]);

  // ==================== COUNTDOWN TIMER ====================
  useEffect(() => {
    const updateCountdown = () => {
      const now = new Date();
      
      // Find the most relevant active window
      const relevantWindow = activeWindows.find(w => {
        const start = new Date(w.start_time);
        const end = new Date(w.end_time);
        return now >= start && now <= end;
      });

      if (relevantWindow) {
        const endTime = new Date(relevantWindow.end_time);
        const timeDiff = endTime.getTime() - now.getTime();
        
        if (timeDiff > 0) {
          const hours = Math.floor(timeDiff / (1000 * 60 * 60));
          const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
          
          if (hours > 0) {
            setCountdown(`${hours}h ${minutes}m ${seconds}s`);
          } else if (minutes > 0) {
            setCountdown(`${minutes}m ${seconds}s`);
          } else {
            setCountdown(`${seconds}s`);
          }
        } else {
          setCountdown('Expired');
        }
      } else {
        setCountdown('');
      }
    };

    updateCountdown();
    const interval = setInterval(updateCountdown, 1000);
    
    return () => clearInterval(interval);
  }, [activeWindows]);

  // ==================== LIVE PRICE DATA ====================
  const [currentPrice, setCurrentPrice] = useState(67000);
  const [priceChange, setPriceChange] = useState(2.34);

  // Live price stream
  const currentPair = getCurrentPair();
  const binanceSymbol = `${currentPair.baseAsset}${currentPair.quoteAsset}`.toLowerCase();
  const tradeStream = useBinanceStream(binanceSymbol, 'trade');
  
  useEffect(() => {
    if (tradeStream && tradeStream.p) {
      const newPrice = parseFloat(tradeStream.p);
      setCurrentPrice(newPrice);
      
      const updatedPair = {
        ...currentPair,
        price: newPrice,
        change: (Math.random() * 10 - 5)
      };
      
      if (tab === 'spot') setSpotPair(updatedPair);
      else if (tab === 'futures') setFuturesPair(updatedPair);
      else if (tab === 'option') setOptionsPair(updatedPair);
    }
  }, [tradeStream, currentPair.price, tab]);

  // ==================== ORDER BOOK ====================
  const [orderBook, setOrderBook] = useState<OrderBook>({
    bids: [],
    asks: []
  });

  useEffect(() => {
    const generateOrderBook = () => {
      const bids: OrderBookEntry[] = [];
      const asks: OrderBookEntry[] = [];
      
      for (let i = 0; i < 10; i++) {
        const bidPrice = currentPrice * (1 - (i + 1) * 0.001);
        const askPrice = currentPrice * (1 + (i + 1) * 0.001);
        const amount = Math.random() * 10 + 1;
        
        bids.push({
          price: bidPrice,
          amount,
          total: bidPrice * amount
        });
        
        asks.push({
          price: askPrice,
          amount,
          total: askPrice * amount
        });
      }
      
      setOrderBook({ bids, asks });
    };

    generateOrderBook();
    const interval = setInterval(generateOrderBook, 5000);
    return () => clearInterval(interval);
  }, [currentPrice]);

  // ==================== RECENT TRADES ====================
  const [recentTrades, setRecentTrades] = useState<Trade[]>([]);

  useEffect(() => {
    const generateTrade = () => {
      const side = Math.random() > 0.5 ? 'buy' : 'sell';
      const price = currentPrice * (1 + (Math.random() - 0.5) * 0.002);
      const amount = Math.random() * 5 + 0.1;
      
      const newTrade: Trade = {
        id: Date.now().toString(),
        price,
        amount,
        total: price * amount,
        side,
        time: Date.now()
      };
      
      setRecentTrades(prev => [newTrade, ...prev].slice(0, 20));
    };

    const interval = setInterval(generateTrade, 2000);
    return () => clearInterval(interval);
  }, [currentPrice]);

  // ==================== TRADING STATE ====================
  const [spotSide, setSpotSide] = useState<'buy' | 'sell'>('buy');
  const [spotOrderType, setSpotOrderType] = useState<'market' | 'limit' | 'stop'>('market');
  const [spotPrice, setSpotPrice] = useState('');
  const [spotAmount, setSpotAmount] = useState('');
  const [spotPercent, setSpotPercent] = useState(0);

  const [futuresSide, setFuturesSide] = useState<'buy' | 'sell'>('buy');
  const [futuresPositionType, setFuturesPositionType] = useState<'open' | 'close'>('open');
  const [futuresOrderType, setFuturesOrderType] = useState<'market' | 'limit' | 'stop'>('market');
  const [futuresPrice, setFuturesPrice] = useState('');
  const [futuresAmount, setFuturesAmount] = useState('');
  const [futuresPercent, setFuturesPercent] = useState(0);
  const [futuresLeverage, setFuturesLeverage] = useState(10);
  const [futuresTpSl, setFuturesTpSl] = useState(false);

  const [optionsDirection, setOptionsDirection] = useState<'up' | 'down'>('up');
  const [optionsTime, setOptionsTime] = useState(60);
  const [optionsAmount, setOptionsAmount] = useState('');
  const timeRanges = [60, 120, 240, 360, 600];
  
  const profitRates: Record<number, { payout: number; profit: number }> = {
    60: { payout: 0.85, profit: 15 },
    120: { payout: 0.82, profit: 18 },
    240: { payout: 0.78, profit: 22 },
    360: { payout: 0.75, profit: 25 },
    600: { payout: 0.70, profit: 30 }
  };

  // ==================== UI STATE ====================
  const [pairSelectorOpen, setPairSelectorOpen] = useState(false);
  const [showOrderBook, setShowOrderBook] = useState(true);
  const [showRecentTrades, setShowRecentTrades] = useState(true);
  const [transactions, setTransactions] = useState<any[]>([]);
  const [orderHistoryTab, setOrderHistoryTab] = useState<'active' | 'scheduled' | 'completed'>('active');

  // ==================== ORDER CATEGORIZATION HELPERS ====================
  
  const getActiveOrders = useCallback(() => {
    return transactions.filter(tx => 
      tx.status === 'active' || 
      tx.status === 'pending' ||
      tx.status === 'processing'
    );
  }, [transactions]);

  const getScheduledOrders = useCallback(() => {
    return transactions.filter(tx => 
      tx.status === 'scheduled' ||
      (tx.metadata?.expiresAt && tx.metadata.expiresAt > Date.now())
    );
  }, [transactions]);

  const getCompletedOrders = useCallback(() => {
    return transactions.filter(tx => 
      tx.status === 'completed' ||
      tx.status === 'failed' ||
      tx.status === 'cancelled'
    );
  }, [transactions]);

  // ==================== HANDLERS ====================

  const handlePairSelect = useCallback((pair: { name: string; price?: number; change?: number }) => {
    const [base, quote] = pair.name.split('/');
    const newPair: TradingPair = {
      label: pair.name,
      baseAsset: base,
      quoteAsset: quote || 'USDT',
      price: pair.price || currentPrice,
      change: pair.change || 0,
      volume: currentPair.volume,
      high: currentPair.high,
      low: currentPair.low
    };
    
    updateCurrentPair(newPair);
    setPairSelectorOpen(false);
    
    const params = new URLSearchParams(searchParams);
    params.set('pair', pair.name);
    if (tab === 'futures') params.set('market', 'Futures');
    else if (tab === 'option') params.set('market', 'Options');
    else params.set('market', 'Crypto');
    
    navigate(`?${params.toString()}`, { replace: true });
    
    toast({
      title: "Pair Changed",
      description: `Now trading ${pair.name}`,
    });
  }, [currentPair, currentPrice, updateCurrentPair, tab, navigate, searchParams]);

  const getCurrentTab = useCallback(() => {
    if (tab === 'spot') return 'Crypto';
    if (tab === 'futures') return 'Futures';
    return 'Crypto';
  }, [tab]);

  // Calculate win/loss outcome based on admin settings
  const determineOutcome = useCallback(async (tradeType: string): Promise<boolean> => {
    console.log('ðŸŽ² [Trading] determineOutcome called', {
      tradeType,
      userId: user?.id,
      userOutcome,
      activeWindows: activeWindows.length,
      systemSettings
    });

    if (!user?.id) return false;

    // Check if there's an active window for this user
    const activeWindow = activeWindows.find(w => {
      const now = new Date();
      const start = new Date(w.start_time);
      const end = new Date(w.end_time);
      return now >= start && now <= end;
    });

    console.log('ðŸŽ² [Trading] activeWindow found:', activeWindow);

    if (activeWindow) {
      // Check if this trade type is enabled in the window
      const isEnabled = (
        (tradeType === 'spot' && activeWindow.spot_enabled) ||
        (tradeType === 'futures' && activeWindow.futures_enabled) ||
        (tradeType === 'options' && activeWindow.options_enabled) ||
        (tradeType === 'arbitrage' && activeWindow.arbitrage_enabled)
      );

      console.log('ðŸŽ² [Trading] window enabled for trade type:', isEnabled);

      if (isEnabled) {
        const result = activeWindow.outcome_type === 'win';
        console.log('ðŸŽ² [Trading] window outcome result:', result);
        return result;
      }
    }

    // Check if user has permanent outcome settings
    if (userOutcome?.enabled) {
      const isEnabled = (
        (tradeType === 'spot' && userOutcome.spot_enabled) ||
        (tradeType === 'futures' && userOutcome.futures_enabled) ||
        (tradeType === 'options' && userOutcome.options_enabled) ||
        (tradeType === 'arbitrage' && userOutcome.arbitrage_enabled)
      );

      console.log('ðŸŽ² [Trading] user outcome enabled for trade type:', isEnabled);

      if (isEnabled) {
        const result = userOutcome.outcome_type === 'win';
        console.log('ðŸŽ² [Trading] user outcome result:', result);
        return result;
      }
    }

    // Use system defaults
    if (systemSettings) {
      let defaultOutcome = systemSettings.default_outcome;
      
      switch (tradeType) {
        case 'spot':
          defaultOutcome = systemSettings.spot_default;
          break;
        case 'futures':
          defaultOutcome = systemSettings.futures_default;
          break;
        case 'options':
          defaultOutcome = systemSettings.options_default;
          break;
        case 'arbitrage':
          defaultOutcome = systemSettings.arbitrage_default;
          break;
      }

      console.log('ðŸŽ² [Trading] system default outcome:', defaultOutcome);

      if (defaultOutcome === 'win') return true;
      if (defaultOutcome === 'loss') return false;
      if (defaultOutcome === 'random') {
        const result = Math.random() < (systemSettings.win_probability / 100);
        console.log('ðŸŽ² [Trading] random outcome result:', result);
        return result;
      }
    }

    // FALLBACK: If no admin controls are loaded, use random outcome with 50% win rate
    console.log('ðŸŽ² [Trading] No admin controls found, using fallback random outcome');
    const fallbackResult = Math.random() < 0.5;
    console.log('ðŸŽ² [Trading] fallback outcome result:', fallbackResult);
    return fallbackResult;

  // ==================== TRADING HANDLERS ====================

  const handleSpotTrade = useCallback(async () => {
    console.log('ðŸŽ¯ [Trading] handleSpotTrade called', {
      isAuthenticated,
      spotAmount,
      spotOrderType,
      currentPrice,
      spotPrice,
      balancesUSDT: balances.USDT,
      spotSide,
      spotPair,
      outcomeLoading
    });

    if (!isAuthenticated) {
      toast({ 
        title: 'ðŸ”’ Authentication Required', 
        description: 'Please login to place trades.', 
        variant: 'destructive' 
      });
      return;
    }

    const amount = Number(spotAmount);
    const price = spotOrderType === 'market' ? currentPrice : Number(spotPrice);
    
    if (!amount || isNaN(amount) || amount <= 0) {
      toast({ 
        title: 'Error', 
        description: 'Please enter a valid amount.', 
        variant: 'destructive' 
      });
      return;
    }

    const total = amount * price;
  
    // Check balance using database balances
    const usdtBalance = dbBalances.USDT || 0;
    if (total > usdtBalance) {
      toast({ 
        title: 'Insufficient Balance', 
        description: `You need ${total.toFixed(2)} USDT but have ${usdtBalance.toFixed(2)} USDT.`, 
        variant: 'destructive' 
      });
      return;
    }

    try {
      setLoading(true);
      
      // âœ… CORRECT: Use 'spot' for spot trades
      console.log('ï¿½ [Trading] Calling determineOutcome with tradeType: spot');
      const shouldWin = await determineOutcome('spot');
      console.log('ï¿½ [Trading] Trade outcome:', shouldWin ? 'WIN' : 'LOSS');
      
      // Generate order ID
      const orderId = `order_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      
      // âœ… STEP 1: Lock the funds in database
      console.log('ï¿½ [Trading] Locking funds:', { asset: 'USDT', amount: total, reference: orderId });
      
      const tradingLock = {
        user_id: user?.id,
        asset: 'USDT',
        amount: total,
        lock_type: 'spot',
        reference_id: orderId,
        status: 'locked',
        expires_at: new Date(Date.now() + 60000).toISOString(), // 1 minute expiry
        metadata: {
          side: spotSide,
          price: price,
          orderType: spotOrderType,
          pair: spotPair.label,
          shouldWin,
          tradeType: 'spot'
        }
      };

      // Insert trading lock into database
      const { data: lockData, error: lockError } = await supabase
        .from('trading_locks')
        .insert([tradingLock])
        .select();

      if (lockError) {
        console.error('Error creating trading lock:', lockError);
        throw new Error('Failed to lock funds');
      }

      console.log('ðŸ”’ [Trading] Created trading lock:', lockData);

      // âœ… STEP 2: Update wallet balance in database
      const { error: balanceError } = await supabase
        .from('wallets')
        .update({ 
          balance: dbBalances.USDT - total,
          locked_balance: (dbBalances.USDT || 0) + total
        })
        .eq('user_id', user?.id)
        .eq('currency', 'USDT');

      if (balanceError) {
        console.error('Error updating wallet balance:', balanceError);
        throw new Error('Failed to update wallet balance');
      }

      // Update local state
      setDbBalances(prev => ({
        ...prev,
        USDT: prev.USDT - total
      }));
      
      // âœ… STEP 3: Calculate PnL
      const pnl = shouldWin ? total * 0.05 : -total;
      
      // âœ… STEP 4: Create transaction record
      const newTransaction = {
        id: orderId,
        userId: user!.id,
        type: 'Trade',
        asset: spotPair.label,
        amount: amount,
        status: shouldWin ? 'Completed' : 'Failed',
        date: new Date().toISOString(),
        pnl: pnl,
        category: 'spot',
        details: {
          side: spotSide,
          price,
          orderType: spotOrderType,
          pair: spotPair.label,
          shouldWin,
          pnl,
          tradingLockId: lockData[0]?.id
        }
      };
      
      await addTransaction(newTransaction);
      
      // âœ… STEP 5: Handle market orders (immediate execution)
      if (spotOrderType === 'market') {
        if (shouldWin) {
          // Add profit (original stake + profit)
          const profitAmount = total + pnl;
          
          // Update wallet balance in database
          const { error: profitError } = await supabase
            .from('wallets')
            .update({ 
              balance: (dbBalances.USDT || 0) + profitAmount,
              locked_balance: Math.max(0, (dbBalances.USDT || 0) + total - profitAmount)
            })
            .eq('user_id', user?.id)
            .eq('currency', 'USDT');

          if (!profitError) {
            setDbBalances(prev => ({
              ...prev,
              USDT: prev.USDT + profitAmount
            }));
          }

          // Update trading lock status to released
          await supabase
            .from('trading_locks')
            .update({ 
              status: 'released',
              released_at: new Date().toISOString()
            })
            .eq('id', lockData[0]?.id);
          
          toast({ 
            title: 'âœ… Winning Trade!', 
            description: `You won $${pnl.toFixed(2)} profit!`,
          });
        } else {
          // Update trading lock status to failed
          await supabase
            .from('trading_locks')
            .update({ 
              status: 'failed',
              released_at: new Date().toISOString()
            })
            .eq('id', lockData[0]?.id);
          
          toast({ 
            title: 'âŒ Trade Lost', 
            description: `You lost $${total.toFixed(2)}`,
            variant: 'destructive'
          });
        }
      } else {
        // Show initial message for limit orders
        toast({ 
          title: 'â° Order Placed', 
          description: `Your ${spotOrderType} order has been placed`,
        });
      }
      
      // Clear form
      setSpotAmount('');
      setSpotPrice('');
      setSpotPercent(0);
      
    } catch (error) {
      console.error('âŒ [Trading] Trade failed:', error);
      toast({ 
        title: 'âŒ Trade Failed', 
        description: error instanceof Error ? error.message : 'Failed to place trade', 
        variant: 'destructive' 
      });
    } finally {
      setLoading(false);
    }
  }, [isAuthenticated, spotAmount, spotOrderType, currentPrice, spotPrice, dbBalances, determineOutcome, addTransaction, user, spotSide, spotPair]);

  const handleFuturesTrade = useCallback(async () => {
    if (!isAuthenticated) {
      toast({ 
        title: 'ðŸ”’ Authentication Required', 
        description: 'Please login to place trades.', 
        variant: 'destructive' 
      });
      return;
    }

    const amount = Number(futuresAmount);
    const price = futuresOrderType === 'market' ? currentPrice : Number(futuresPrice);
    
    toast({ 
      title: 'âœ… Winning Trade!', 
      description: `You won $${pnl.toFixed(2)} profit!`,
              amount: margin + finalPnl, // Return original margin + profit
              status: 'Win',
              date: new Date().toISOString(),
              details: {
                side: futuresSide,
                price: price,
                leverage: futuresLeverage,
                orderType: futuresOrderType,
                positionType: futuresPositionType,
                shouldWin,
                pnl: finalPnl,
                settlement: true
              },
              category: 'futures'
            });
            
            toast({ 
              title: 'âœ… Winning Futures Trade!', 
              description: `You won $${finalPnl.toFixed(2)} profit!`,
            });
          } else {
            toast({ 
              title: 'âŒ Futures Trade Lost', 
              description: `You lost $${margin.toFixed(2)} margin`,
              variant: 'destructive'
            });
          }
        }, 2000);
        
        // Show initial message for limit orders
        toast({ 
          title: 'â° Position Placed', 
          description: `Your ${futuresOrderType} position has been placed`,
        });
      }

      setFuturesAmount('');
      setFuturesPrice('');
      setFuturesPercent(0);
      
    } catch (error) {
      toast({ 
        title: 'âŒ Position Failed', 
        description: error instanceof Error ? error.message : 'Failed to open position', 
        variant: 'destructive' 
      });
    }
  }, [isAuthenticated, futuresAmount, futuresOrderType, currentPrice, futuresPrice, futuresLeverage, balances.USDT, futuresSide, futuresPair, futuresPositionType, determineOutcome, user]);

  const handleOptionsTrade = useCallback(async () => {
    if (!isAuthenticated) {
      toast({ 
        title: 'ðŸ”’ Authentication Required', 
        description: 'Please login to place trades.', 
        variant: 'destructive' 
      });
      return;
    }

    const amount = Number(optionsAmount);
    
    if (!amount || isNaN(amount) || amount <= 0) {
      toast({ 
        title: 'Error', 
        description: 'Please enter a valid amount.', 
              direction: optionsDirection,
              price: currentPrice,
              timeFrame: optionsTime,
              profitRate: rate,
              expectedProfit: 0,
              endTime,
              shouldWin,
              pnl: -amount
            },
            category: 'options'
          });
          
          toast({ 
            title: 'âŒ Options Trade Lost', 
            description: `You lost $${amount.toFixed(2)}`,
            variant: 'destructive'
          });
        }
      }, optionsTime * 1000);
      
      // Set initial P&L to 0 for scheduled options
      pnl = 0;

      const newTransaction = {
        id: Date.now().toString(),
        type: 'Trade',
        asset: optionsPair.label,
        amount,
        status,
        date: new Date().toISOString(),
        pnl,
        details: {
          direction: optionsDirection,
          price: currentPrice,
          timeFrame: optionsTime,
          profitRate: rate,
          expectedProfit: shouldWin ? payout - amount : 0,
          endTime,
          shouldWin,
          pnl
        }
      };
      
      setTransactions(prev => [newTransaction, ...prev]);
      
      // Show initial message
      toast({ 
        title: 'â° Options Trade Placed', 
        description: `Your ${optionsDirection} option will expire in ${optionsTime} seconds`,
      });

      setOptionsAmount('');
      
    } catch (error) {
      toast({ 
        title: 'âŒ Option Failed', 
        description: error instanceof Error ? error.message : 'Failed to purchase option', 
        variant: 'destructive' 
      });
    }
  }, [isAuthenticated, optionsAmount, balances.USDT, optionsTime, optionsDirection, currentPrice, optionsPair, profitRates, determineOutcome, user]);

  // Show special badge if user has force win enabled
  const renderForceWinBadge = () => {
    if (userOutcome?.enabled && userOutcome.outcome_type === 'win') {
      return (
        <Badge className="bg-emerald-500/20 text-emerald-400 border-emerald-500/30 ml-2 animate-pulse">
          <Crown className="w-3 h-3 mr-1" />
          Force Win Active
        </Badge>
      );
    }
    
    const activeWindow = activeWindows.find(w => {
      const now = new Date();
      const start = new Date(w.start_time);
      const end = new Date(w.end_time);
      return now >= start && now <= end && w.outcome_type === 'win';
    });

    if (activeWindow) {
      return (
        <Badge className="bg-amber-500/20 text-amber-400 border-amber-500/30 ml-2">
          <Clock className="w-3 h-3 mr-1" />
          Win Window Active
        </Badge>
      );
    }

    return null;
  };

  return (
    <ErrorBoundary>
      <div className="min-h-screen bg-[#181A20] pb-16 md:pb-20">
        {/* Mobile Header - Sticky */}
        <div className="sticky top-0 z-30 bg-[#181A20]/95 backdrop-blur border-b border-[#2B3139]">
          <div className="container mx-auto px-3 py-3 md:py-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <button 
                  className="p-2 hover:bg-[#23262F] rounded-lg transition-colors" 
                  onClick={() => setPairSelectorOpen(true)}
                >
                  <Menu size={22} className="text-[#848E9C]" />
                </button>
                <button
                  className="flex items-center gap-3 p-2 hover:bg-[#23262F] rounded-lg transition-colors"
                  onClick={() => setPairSelectorOpen(true)}
                >
                  <div className="flex flex-col items-start">
                    <div className="flex items-center gap-2">
                      <span className="text-xl md:text-2xl font-bold text-[#EAECEF]">
                        {getCurrentPair().label}
                      </span>
                      {renderForceWinBadge()}
                    </div>
                    <div className="flex items-center gap-2">
                      <span className="text-lg text-green-500 font-mono">
                        ${formatPrice(getCurrentPair().price)}
                      </span>
                      <Badge className={getCurrentPair().change && getCurrentPair().change! >= 0 ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}>
                        {getCurrentPair().change && getCurrentPair().change! >= 0 ? '+' : ''}{getCurrentPair().change?.toFixed(2)}%
                      </Badge>
                    </div>
                  </div>
                  <ChevronDown size={18} className="text-[#848E9C]" />
                </button>
              </div>
              <div className="flex gap-1 md:gap-2">
                <button className="p-2 hover:bg-[#23262F] rounded-lg transition-colors" title="Favorite">
                  <Star size={20} className="text-[#848E9C]" />
                </button>
                <button className="p-2 hover:bg-[#23262F] rounded-lg transition-colors" title="Settings">
                  <Settings size={20} className="text-[#848E9C]" />
                </button>
              </div>
            </div>
            
            {/* Mobile Tabs */}
            <div className="mt-3">
              <Tabs value={tab} onValueChange={v => setTab(v as any)} className="w-full">
                <TabsList className="grid grid-cols-3 w-full bg-[#1E2329] p-1 rounded-xl">
                  <TabsTrigger value="spot" className="text-sm md:text-base data-[state=active]:bg-[#F0B90B] data-[state=active]:text-[#181A20] rounded-lg">
                    Spot
                  </TabsTrigger>
                  <TabsTrigger value="futures" className="text-sm md:text-base data-[state=active]:bg-[#F0B90B] data-[state=active]:text-[#181A20] rounded-lg">
                    Futures
                  </TabsTrigger>
                  <TabsTrigger value="option" className="text-sm md:text-base data-[state=active]:bg-[#F0B90B] data-[state=active]:text-[#181A20] rounded-lg">
                    Option
                  </TabsTrigger>
                </TabsList>
              </Tabs>
            </div>
          </div>
        </div>

        <div className="container mx-auto px-3 py-4">
          {/* Pair Selector Modal */}
          <EnhancedPairSelectorModal
            open={pairSelectorOpen}
            onClose={() => setPairSelectorOpen(false)}
            currentTab={getCurrentTab()}
            onSelectPair={handlePairSelect}
          />

          {/* Mobile Quick Stats */}
          <div className="grid grid-cols-3 gap-2 mb-4 md:hidden">
            <Card className="bg-[#1E2329] border border-[#2B3139] p-3">
              <div className="text-xs text-[#848E9C]">Balance</div>
              <div className="font-bold text-[#EAECEF]">${(balances.USDT || 0).toLocaleString()}</div>
            </Card>
            <Card className="bg-[#1E2329] border border-[#2B3139] p-3">
              <div className="text-xs text-[#848E9C]">24h Change</div>
              <div className={`font-bold ${getCurrentPair().change && getCurrentPair().change! >= 0 ? 'text-green-500' : 'text-red-500'}`}>
                {getCurrentPair().change && getCurrentPair().change! >= 0 ? '+' : ''}{getCurrentPair().change?.toFixed(2)}%
              </div>
            </Card>
            <Card className="bg-[#1E2329] border border-[#2B3139] p-3">
              <div className="text-xs text-[#848E9C]">24h Volume</div>
              <div className="font-bold text-[#EAECEF]">${((getCurrentPair().volume || 0) / 1e6).toFixed(1)}M</div>
            </Card>
          </div>

          {/* Authentication Banner for Unauthenticated Users */}
          {!isAuthenticated && (
            <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4 mb-4">
              <div className="flex items-center gap-3">
                <AlertTriangle className="w-5 h-5 text-yellow-400 flex-shrink-0" />
                <div>
                  <p className="text-sm font-medium text-yellow-400">View Only Mode</p>
                  <p className="text-xs text-yellow-300 mt-1">
                    You're viewing the trading interface in read-only mode. 
                    <button 
                      onClick={() => navigate('/login')}
                      className="underline hover:text-yellow-200 ml-1"
                    >
                      Login
                    </button> to place real trades.
                  </p>
                </div>
              </div>
            </div>
          )}

          {/* Trading Control Status Banner */}
          {userOutcome?.enabled && (
            <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-lg p-3 mb-4">
              <div className="flex items-center gap-2">
                <Crown className="w-4 h-4 text-emerald-400" />
                <p className="text-sm text-emerald-400">
                  Force win is enabled for your account. You will win all trades!
                </p>
              </div>
            </div>
          )}

          {activeWindows.length > 0 && (
            <div className="bg-amber-500/10 border border-amber-500/30 rounded-lg p-3 mb-4">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <Clock className="w-4 h-4 text-amber-400" />
                  <p className="text-sm text-amber-400">
                    Active trading windows: {activeWindows.map(w => 
                      `${w.outcome_type.toUpperCase()} (${new Date(w.start_time).toLocaleTimeString()}-${new Date(w.end_time).toLocaleTimeString()})`
                    ).join(', ')}
                  </p>
                </div>
                {countdown && (
                  <Badge className="bg-amber-500/20 text-amber-400 border-amber-500/30">
                    <Clock className="w-3 h-3 mr-1" />
                    {countdown}
                  </Badge>
                )}
              </div>
            </div>
          )}

          {/* Main Trading Layout */}
          <div className="grid grid-cols-1 lg:grid-cols-12 gap-4 md:gap-6">
            
            {/* Left Column - Chart */}
            <div className="lg:col-span-7 order-1">
              <Card className="bg-[#1E2329] border border-[#2B3139] p-3 md:p-4">
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-2">
                    <BarChart3 size={18} className="text-[#F0B90B]" />
                    <span className="font-semibold text-sm md:text-base text-[#EAECEF]">Price Chart - {getCurrentPair().label}</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <Badge className="bg-[#2B3139] text-[#848E9C]">
                      <Activity size={12} className="mr-1" />
                      1m
                    </Badge>
                    <Badge className="bg-green-500/20 text-green-400">
                      Live
                    </Badge>
                  </div>
                </div>
                <TradingViewWidget 
                  symbol={getCurrentPair().label.replace('/', '')} 
                />
              </Card>
            </div>

            {/* Center Column - Order Form */}
            <div className="lg:col-span-5 order-2 space-y-4">
              {tab === 'spot' && (
                <Card className="bg-[#1E2329] border border-[#F0B90B] p-4 md:p-6">
                  {/* Trading Pair Display */}
                  <div className="flex items-center justify-between mb-4 pb-3 border-b border-[#2B3139]">
                    <div>
                      <div className="text-xs text-[#848E9C]">Trading</div>
                      <div className="font-bold text-[#EAECEF]">{spotPair.label}</div>
                    </div>
                    <div className="text-right">
                      <div className="text-xs text-[#848E9C]">Price</div>
                      <div className="font-bold text-green-500">${formatPrice(spotPair.price)}</div>
                    </div>
                    <Button
                      size="sm"
                      variant="ghost"
                      className="text-[#F0B90B]"
                      onClick={() => setPairSelectorOpen(true)}
                    >
                      Change <ChevronDown size={14} className="ml-1" />
                    </Button>
                  </div>

                  {/* Buy/Sell Toggle */}
                  <div className="flex mb-4 bg-[#1E2329] p-1 rounded-xl border border-[#2B3139]">
                    <button
                      className={`flex-1 py-2.5 rounded-lg font-semibold text-sm md:text-base transition-all ${
                        spotSide === 'buy' 
                          ? 'bg-green-500 text-white shadow-lg shadow-green-500/20' 
                          : 'text-[#848E9C] hover:text-white'
                      }`}
                      onClick={() => setSpotSide('buy')}
                    >
                      Buy {spotPair.baseAsset}
                    </button>
                    <button
                      className={`flex-1 py-2.5 rounded-lg font-semibold text-sm md:text-base transition-all ${
                        spotSide === 'sell' 
                          ? 'bg-red-500 text-white shadow-lg shadow-red-500/20' 
                          : 'text-[#848E9C] hover:text-white'
                      }`}
                      onClick={() => setSpotSide('sell')}
                    >
                      Sell {spotPair.baseAsset}
                    </button>
                  </div>

                  {/* Order Form */}
                  <div className="space-y-3">
                    <Select value={spotOrderType} onValueChange={value => setSpotOrderType(value as any)}>
                      <SelectTrigger className="w-full bg-[#181A20] border-[#2B3139] text-[#EAECEF] h-11">
                        <SelectValue placeholder="Order Type" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="market">Market</SelectItem>
                        <SelectItem value="limit">Limit</SelectItem>
                        <SelectItem value="stop">Stop</SelectItem>
                      </SelectContent>
                    </Select>

                    <div className="relative">
                      <Input
                        type="number"
                        className="w-full bg-[#181A20] border border-[#2B3139] rounded-lg px-4 py-3 text-[#EAECEF] text-sm md:text-base pr-16"
                        value={spotOrderType === 'market' ? currentPrice.toString() : spotPrice}
                        onChange={e => setSpotPrice(e.target.value)}
                        placeholder="Price"
                        disabled={spotOrderType === 'market'}
                      />
                      <span className="absolute right-3 top-1/2 -translate-y-1/2 text-[#848E9C] text-xs">USDT</span>
                    </div>

                    <div className="relative">
                      <Input
                        type="number"
                        className="w-full bg-[#181A20] border border-[#2B3139] rounded-lg px-4 py-3 text-[#EAECEF] text-sm md:text-base pr-16"
                        value={spotAmount}
                        onChange={e => setSpotAmount(e.target.value)}
                        placeholder={`Amount in ${spotPair.baseAsset}`}
                      />
                      <span className="absolute right-3 top-1/2 -translate-y-1/2 text-[#848E9C] text-xs">{spotPair.baseAsset}</span>
                    </div>

                    {/* Percentage Slider */}
                    <div className="flex items-center gap-3">
                      <input 
                        type="range" 
                        min={0} 
                        max={100} 
                        value={spotPercent} 
                        onChange={e => setSpotPercent(Number(e.target.value))} 
                        className="flex-1 h-2 bg-[#2B3139] rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-[#F0B90B]"
                      />
                      <span className="text-[#EAECEF] text-sm w-12 text-right">{spotPercent}%</span>
                    </div>

                    {/* Balance & Fee */}
                    <div className="flex justify-between text-xs md:text-sm bg-[#181A20] rounded-lg p-3">
                      <span className="text-[#848E9C]">Available</span>
                      <span className="text-[#EAECEF] font-medium">{(balances.USDT || 0).toLocaleString()} USDT</span>
                      <span className="text-[#848E9C] ml-auto mr-2">Fee</span>
                      <span className="text-[#EAECEF] font-medium">{spotOrderType === 'market' ? '0.1%' : '0.0%'}</span>
                    </div>

                    {/* Order Value */}
                    {spotAmount && (
                      <div className="bg-[#181A20] rounded-lg p-3">
                        <div className="flex justify-between text-sm">
                          <span className="text-[#848E9C]">Total Value</span>
                          <span className="text-[#EAECEF] font-medium">
                            ${(Number(spotAmount) * (spotOrderType === 'market' ? currentPrice : Number(spotPrice || currentPrice))).toFixed(2)}
                          </span>
                        </div>
                      </div>
                    )}

                    {/* Action Button */}
                    <button
                      className={`w-full py-3.5 rounded-lg font-bold text-sm md:text-base transition-all ${
                        spotSide === 'buy' 
                          ? 'bg-green-500 hover:bg-green-600 text-white shadow-lg shadow-green-500/30' 
                          : 'bg-red-500 hover:bg-red-600 text-white shadow-lg shadow-red-500/30'
                      }`}
                      onClick={() => {
                        console.log('ðŸ”˜ [Trading] Button clicked!');
                        handleSpotTrade();
                      }}
                      disabled={!spotAmount || !isAuthenticated || outcomeLoading}
                    >
                      {spotSide === 'buy' ? `Buy ${spotPair.baseAsset}` : `Sell ${spotPair.baseAsset}`}
                    </button>
                  </div>
                </Card>
              )}

              {tab === 'futures' && (
                <Card className="bg-[#1E2329] border border-[#F0B90B] p-4 md:p-6">
                  {/* Trading Pair Display */}
                  <div className="flex items-center justify-between mb-4 pb-3 border-b border-[#2B3139]">
                    <div>
                      <div className="text-xs text-[#848E9C]">Trading</div>
                      <div className="font-bold text-[#EAECEF]">{futuresPair.label}</div>
                    </div>
                    <div className="text-right">
                      <div className="text-xs text-[#848E9C]">Price</div>
                      <div className="font-bold text-green-500">${formatPrice(futuresPair.price)}</div>
                    </div>
                    <Button
                      size="sm"
                      variant="ghost"
                      className="text-[#F0B90B]"
                      onClick={() => setPairSelectorOpen(true)}
                    >
                      Change <ChevronDown size={14} className="ml-1" />
                    </Button>
                  </div>

                  {/* Leverage & Position Type */}
                  <div className="space-y-4">
                    <div className="flex gap-2">
                      <Select value={String(futuresLeverage)} onValueChange={value => setFuturesLeverage(Number(value))}>
                        <SelectTrigger className="flex-1 bg-[#181A20] border-[#2B3139] text-[#EAECEF] h-11">
                          <SelectValue placeholder="Leverage" />
                        </SelectTrigger>
                        <SelectContent>
                          {[1, 2, 5, 10, 20, 50, 100].map(lv => (
                            <SelectItem key={lv} value={String(lv)}>{lv}x</SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                      
                      <div className="flex flex-1 bg-[#1E2329] p-1 rounded-xl border border-[#2B3139]">
                        <button
                          className={`flex-1 py-2 rounded-lg text-xs md:text-sm font-medium transition-all ${
                            futuresPositionType === 'open' 
                              ? 'bg-[#F0B90B] text-[#181A20]' 
                              : 'text-[#848E9C] hover:text-[#EAECEF]'
                          }`}
                          onClick={() => setFuturesPositionType('open')}
                        >
                          Open
                        </button>
                        <button
                          className={`flex-1 py-2 rounded-lg text-xs md:text-sm font-medium transition-all ${
                            futuresPositionType === 'close' 
                              ? 'bg-[#F0B90B] text-[#181A20]' 
                              : 'text-[#848E9C] hover:text-[#EAECEF]'
                          }`}
                          onClick={() => setFuturesPositionType('close')}
                        >
                          Close
                        </button>
                      </div>
                    </div>

                    {/* Order Form */}
                    <Select value={futuresOrderType} onValueChange={value => setFuturesOrderType(value as any)}>
                      <SelectTrigger className="w-full bg-[#181A20] border-[#2B3139] text-[#EAECEF] h-11">
                        <SelectValue placeholder="Order Type" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="market">Market</SelectItem>
                        <SelectItem value="limit">Limit</SelectItem>
                        <SelectItem value="stop">Stop</SelectItem>
                      </SelectContent>
                    </Select>

                    <div className="relative">
                      <Input
                        type="number"
                        className="w-full bg-[#181A20] border border-[#2B3139] rounded-lg px-4 py-3 text-[#EAECEF] text-sm md:text-base pr-16"
                        value={futuresOrderType === 'market' ? currentPrice.toString() : futuresPrice}
                        onChange={e => setFuturesPrice(e.target.value)}
                        placeholder="Price"
                        disabled={futuresOrderType === 'market'}
                      />
                      <span className="absolute right-3 top-1/2 -translate-y-1/2 text-[#848E9C] text-xs">USDT</span>
                    </div>

                    <div className="relative">
                      <Input
                        type="number"
                        className="w-full bg-[#181A20] border border-[#2B3139] rounded-lg px-4 py-3 text-[#EAECEF] text-sm md:text-base pr-16"
                        value={futuresAmount}
                        onChange={e => setFuturesAmount(e.target.value)}
                        placeholder="Amount in USDT"
                      />
                      <span className="absolute right-3 top-1/2 -translate-y-1/2 text-[#848E9C] text-xs">USDT</span>
                    </div>

                    {/* TP/SL */}
                    <label className="flex items-center gap-2 text-sm">
                      <input 
                        type="checkbox" 
                        checked={futuresTpSl} 
                        onChange={e => setFuturesTpSl(e.target.checked)}
                        className="w-4 h-4 rounded border-[#2B3139] bg-[#181A20] text-[#F0B90B] focus:ring-[#F0B90B]"
                      />
                      <span className="text-[#EAECEF]">Take Profit / Stop Loss</span>
                    </label>

                    {/* Margin Info */}
                    {futuresAmount && (
                      <div className="bg-[#181A20] rounded-lg p-3 space-y-1 text-sm">
                        <div className="flex justify-between">
                          <span className="text-[#848E9C]">Position Size</span>
                          <span className="text-[#EAECEF] font-medium">
                            ${(Number(futuresAmount) * futuresLeverage).toLocaleString()}
                          </span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-[#848E9C]">Margin Required</span>
                          <span className="text-[#F0B90B] font-medium">
                            ${(Number(futuresAmount) / futuresLeverage).toLocaleString()}
                          </span>
                        </div>
                      </div>
                    )}

                    <button
                      className="w-full bg-[#F0B90B] hover:bg-yellow-400 text-[#181A20] py-3.5 rounded-lg font-bold text-sm md:text-base transition-all shadow-lg shadow-[#F0B90B]/30 disabled:opacity-50"
                      onClick={handleFuturesTrade}
                      disabled={!futuresAmount || !isAuthenticated || outcomeLoading}
                    >
                      {futuresPositionType === 'open' ? `Open ${futuresSide === 'buy' ? 'Long' : 'Short'}` : 'Close Position'}
                    </button>
                  </div>
                </Card>
              )}

              {tab === 'option' && (
                <div className="bg-[#1E2329] border border-[#F0B90B] p-4 md:p-6 rounded-lg">
                  {/* Trading Pair Display */}
                  <div className="flex items-center justify-between mb-4 pb-3 border-b border-[#2B3139]">
                    <div>
                      <div className="text-xs text-[#848E9C]">Trading</div>
                      <div className="font-bold text-[#EAECEF]">{optionsPair.label}</div>
                    </div>
                    <div className="text-right">
                      <div className="text-xs text-[#848E9C]">Price</div>
                      <div className="font-bold text-green-500">${formatPrice(optionsPair.price)}</div>
                    </div>
                    <Button
                      size="sm"
                      variant="ghost"
                      className="text-[#F0B90B]"
                      onClick={() => setPairSelectorOpen(true)}
                    >
                      Change <ChevronDown size={14} className="ml-1" />
                    </Button>
                  </div>

                  <h2 className="text-lg md:text-xl font-bold mb-4 text-[#F0B90B] flex items-center gap-2">
                    <Zap size={20} />
                    Options Trading
                  </h2>
                  
                  <div className="space-y-4">
                    {/* Direction Selection */}
                    <div>
                      <label className="text-xs md:text-sm text-[#848E9C] mb-1 block">Direction</label>
                      <div className="grid grid-cols-2 gap-3">
                        <button
                          className={`flex items-center justify-center gap-2 p-3 rounded-xl border transition-all ${
                            optionsDirection === 'up' 
                              ? 'bg-green-500/20 border-green-500 text-green-500' 
                              : 'bg-[#181A20] border-[#2B3139] text-[#848E9C] hover:text-green-500 hover:border-green-500/50'
                          }`}
                          onClick={() => setOptionsDirection('up')}
                        >
                          <TrendingUp size={16} />
                          <span className="font-bold">Up</span>
                        </button>
                        <button
                          className={`flex items-center justify-center gap-2 p-3 rounded-xl border transition-all ${
                            optionsDirection === 'down' 
                              ? 'bg-red-500/20 border-red-500 text-red-500' 
                              : 'bg-[#181A20] border-[#2B3139] text-[#848E9C] hover:text-red-500 hover:border-red-500/50'
                          }`}
                          onClick={() => setOptionsDirection('down')}
                        >
                          <TrendingUp size={16} className="rotate-180" />
                          <span className="font-bold">Down</span>
                        </button>
                      </div>
                    </div>

                    {/* Time Range */}
                    <div>
                      <label className="text-xs md:text-sm text-[#848E9C] mb-2 block">Expiry Time</label>
                      <div className="grid grid-cols-5 gap-1.5">
                        {timeRanges.map((t) => {
                          const rate = profitRates[t];
                          return (
                            <button
                              key={t}
                              className={`py-2 rounded-lg text-xs md:text-sm font-medium transition-all ${
                                optionsTime === t 
                                  ? 'bg-[#F0B90B] text-[#181A20]' 
                                  : 'bg-[#181A20] text-[#848E9C] border border-[#2B3139] hover:border-[#F0B90B]/50'
                              }`}
                              onClick={() => setOptionsTime(t)}
                            >
                              <div>{t}s</div>
                              <div className="text-[10px] opacity-80">+{rate?.profit}%</div>
                            </button>
                          );
                        })}
                      </div>
                    </div>

                    {/* Amount Input */}
                    <div className="relative">
                      <Input
                        type="number"
                        placeholder="Amount"
                        value={optionsAmount}
                        onChange={e => setOptionsAmount(e.target.value)}
                        className="w-full bg-[#181A20] border border-[#2B3139] rounded-lg px-4 py-3 text-[#EAECEF] text-sm md:text-base pr-16"
                      />
                      <span className="absolute right-3 top-1/2 -translate-y-1/2 text-[#848E9C] text-xs">USDT</span>
                    </div>

                    {/* Trade Summary */}
                    <div className="bg-[#181A20] rounded-lg p-3 space-y-2">
                      <div className="flex justify-between text-sm">
                        <span className="text-[#848E9C]">Available Balance</span>
                        <span className="text-[#EAECEF] font-medium">{Number(dbBalances.USDT || 0).toLocaleString()} USDT</span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-[#848E9C]">Investment</span>
                        <span className="text-[#EAECEF] font-medium">
                          {optionsAmount ? `$${Number(optionsAmount).toLocaleString()}` : '$0'}
                        </span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-[#848E9C]">Potential Payout</span>
                        <span className="text-green-400 font-medium">
                          {(() => {
                            const amt = Number(optionsAmount);
                            if (!amt) return '$0';
                            const rate = profitRates[optionsTime]?.payout || 0.8;
                            return `$${(amt * rate).toFixed(2)}`;
                          })()}
                        </span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-[#848E9C]">Potential Profit</span>
                        <span className="text-green-400 font-medium">
                          {(() => {
                            const amt = Number(optionsAmount);
                            if (!amt) return '$0';
                            const rate = profitRates[optionsTime]?.payout || 0.8;
                            const profit = amt * rate - amt;
                            return `+$${profit.toFixed(2)}`;
                          })()}
                        </span>
                      </div>
                    </div>

                    {/* Action Button */}
                    <button
                      className="w-full bg-[#F0B90B] hover:bg-yellow-400 text-[#181A20] py-3.5 rounded-lg font-bold text-sm md:text-base transition-all shadow-lg shadow-[#F0B90B]/30 disabled:opacity-50"
                      onClick={handleOptionsTrade}
                      disabled={!optionsAmount || !isAuthenticated || outcomeLoading}
                    >
                      Buy Option
                    </button>
                  </div>
                </div>
              )}
            </div>

            {/* Right Column - Order Book & Trades */}
            <div className="lg:col-span-5 order-3 space-y-4">
              {/* Mobile Toggles */}
              <div className="lg:hidden flex gap-2">
                <button
                  onClick={() => setShowOrderBook(!showOrderBook)}
                  className="flex-1 bg-[#1E2329] border border-[#2B3139] rounded-lg p-2 flex items-center justify-center gap-2 text-sm"
                >
                  <Layers size={16} className="text-[#F0B90B]" />
                  {showOrderBook ? 'Hide' : 'Show'} Order Book
                  <ChevronDown size={14} className={`transition-transform ${showOrderBook ? 'rotate-180' : ''}`} />
                </button>
                <button
                  onClick={() => setShowRecentTrades(!showRecentTrades)}
                  className="flex-1 bg-[#1E2329] border border-[#2B3139] rounded-lg p-2 flex items-center justify-center gap-2 text-sm"
                >
                  <Activity size={16} className="text-[#F0B90B]" />
                  {showRecentTrades ? 'Hide' : 'Show'} Trades
                  <ChevronDown size={14} className={`transition-transform ${showRecentTrades ? 'rotate-180' : ''}`} />
                </button>
              </div>

              {/* Order Book */}
              {(showOrderBook || window.innerWidth >= 1024) && (
                <Card className="bg-[#1E2329] border border-[#2B3139] p-3 md:p-4">
                  <div className="flex items-center justify-between mb-3">
                    <div className="flex items-center gap-2">
                      <Layers size={16} className="text-[#F0B90B]" />
                      <span className="font-semibold text-sm md:text-base text-[#EAECEF]">Order Book - {getCurrentPair().label}</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <Badge className="bg-[#2B3139] text-[#848E9C]">10 levels</Badge>
                    </div>
                  </div>
                  
                  {/* Headers */}
                  <div className="grid grid-cols-3 gap-4 text-xs text-[#848E9C] mb-2 px-2">
                    <span>Price</span>
                    <span className="text-right">Amount</span>
                    <span className="text-right">Total</span>
                  </div>

                  {/* Asks */}
                  <div className="space-y-1 mb-2">
                    {orderBook.asks.slice().reverse().map((ask, i) => (
                      <OrderBookRow key={`ask-${i}`} {...ask} type="ask" />
                    ))}
                  </div>

                  {/* Spread */}
                  {orderBook.asks.length > 0 && orderBook.bids.length > 0 && (
                    <div className="flex items-center justify-between py-2 px-2 bg-[#2B3139]/30 rounded my-1">
                      <span className="text-xs text-[#848E9C]">Spread</span>
                      <span className="text-xs font-mono text-[#EAECEF]">
                        ${(orderBook.asks[0].price - orderBook.bids[0].price).toFixed(2)}
                      </span>
                      <span className="text-xs text-[#848E9C]">
                        {((orderBook.asks[0].price - orderBook.bids[0].price) / orderBook.bids[0].price * 100).toFixed(2)}%
                      </span>
                    </div>
                  )}

                  {/* Bids */}
                  <div className="space-y-1 mt-2">
                    {orderBook.bids.map((bid, i) => (
                      <OrderBookRow key={`bid-${i}`} {...bid} type="bid" />
                    ))}
                  </div>
                </Card>
              )}

              {/* Recent Trades */}
              {(showRecentTrades || window.innerWidth >= 1024) && (
                <Card className="bg-[#1E2329] border border-[#2B3139] p-3 md:p-4">
                  <div className="flex items-center gap-2 mb-3">
                    <History size={16} className="text-[#F0B90B]" />
                    <span className="font-semibold text-sm md:text-base text-[#EAECEF]">Recent Trades</span>
                    <Badge className="bg-[#2B3139] text-[#848E9C] ml-auto">
                      {recentTrades.length} trades
                    </Badge>
                  </div>

                  {/* Headers */}
                  <div className="grid grid-cols-3 gap-4 text-xs text-[#848E9C] mb-2">
                    <span>Price ({getCurrentPair().quoteAsset})</span>
                    <span className="text-right">Amount ({getCurrentPair().baseAsset})</span>
                    <span className="text-right">Time</span>
                  </div>

                  {/* Trades */}
                  <div className="space-y-1 max-h-[200px] md:max-h-[300px] overflow-y-auto custom-scrollbar">
                    {recentTrades.length === 0 ? (
                      <div className="text-xs text-[#5E6673] text-center py-4">Waiting for trades...</div>
                    ) : (
                      recentTrades.map((trade, i) => (
                        <TradeRow key={i} trade={trade} />
                      ))
                    )}
                  </div>
                </Card>
              )}
            </div>
          </div>

          {/* Trading Locks Status */}
          <div className="mt-6 order-5">
            <Card className="bg-[#1E2329] border border-[#2B3139] p-3 md:p-6">
              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center gap-2">
                  <Shield size={18} className="text-[#F0B90B]" />
                  <h3 className="font-semibold text-[#EAECEF]">Trading Locks</h3>
                  {loadingLocks && <RefreshCw size={16} className="animate-spin text-[#848E9C]" />}
                </div>
                <div className="flex items-center gap-2 text-sm">
                  <span className="text-[#848E9C]">Active:</span>
                  <span className="text-[#EAECEF] font-medium">{tradingStats.activeLocks}</span>
                  <span className="text-[#848E9C]">Locked:</span>
                  <span className="text-[#F0B90B] font-medium">{tradingStats.totalLockedAmount.toFixed(2)} USDT</span>
                </div>
              </div>
              
              {tradingLocks.length === 0 ? (
                <div className="text-center py-8 text-[#848E9C] text-sm">
                  No active trading locks. Your available funds are ready for trading.
                </div>
              ) : (
                <div className="space-y-3">
                  {tradingLocks.slice(0, 5).map((lock, index) => (
                    <div key={lock.id} className="bg-[#181A20] border border-[#2B3139] rounded-lg p-3">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                          <div className={`w-2 h-2 rounded-full ${
                            lock.status === 'locked' ? 'bg-yellow-400' : 
                            lock.status === 'released' ? 'bg-green-400' : 
                            lock.status === 'expired' ? 'bg-red-400' : 'bg-gray-400'
                          }`} />
                          <div>
                            <div className="text-sm font-medium text-[#EAECEF]">{String(lock.asset || 'USDT')}</div>
                            <div className="text-xs text-[#848E9C]">{lock.lock_type}</div>
                          </div>
                        </div>
                        <div className="text-right">
                          <div className="text-sm font-medium text-[#EAECEF]">{lock.amount.toFixed(6)} {String(lock.asset || 'USDT')}</div>
                          <div className="text-xs text-[#848E9C]">
                            {tradingDataService.formatLockDuration(lock.expires_at)}
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                  {tradingLocks.length > 5 && (
                    <div className="text-center text-xs text-[#848E9C]">
                      Showing 5 of {tradingLocks.length} active locks
                    </div>
                  )}
                </div>
              )}
            </Card>
          </div>

          {/* Order Management Section */}
          <div className="mt-6 order-4">
            <Card className="bg-[#1E2329] border border-[#2B3139] p-3 md:p-6">
              <div className="flex items-center gap-2 mb-4">
                <History size={18} className="text-[#F0B90B]" />
                <h3 className="font-semibold text-[#EAECEF]">Order History</h3>
              </div>
              
              {transactions.length === 0 ? (
                <div className="text-center py-8 text-[#848E9C] text-sm">
                  No orders yet. Start trading to see your order history.
                </div>
              ) : (
                <Tabs value={orderHistoryTab} onValueChange={(value) => setOrderHistoryTab(value as 'active' | 'scheduled' | 'completed')} className="w-full">
                  <TabsList className="grid w-full grid-cols-3 bg-[#2B3139] border border-[#2B3139]">
                    <TabsTrigger value="active" className="data-[state=active]:bg-[#F0B90B] data-[state=active]:text-[#181A20] text-[#848E9C]">
                      Active ({getActiveOrders().length})
                    </TabsTrigger>
                    <TabsTrigger value="scheduled" className="data-[state=active]:bg-[#F0B90B] data-[state=active]:text-[#181A20] text-[#848E9C]">
                      Scheduled ({getScheduledOrders().length})
                    </TabsTrigger>
                    <TabsTrigger value="completed" className="data-[state=active]:bg-[#F0B90B] data-[state=active]:text-[#181A20] text-[#848E9C]">
                      Completed ({getCompletedOrders().length})
                    </TabsTrigger>
                  </TabsList>

                  <TabsContent value="active" className="mt-4">
                    {getActiveOrders().length === 0 ? (
                      <div className="text-center py-8 text-[#848E9C] text-sm">
                        No active orders.
                      </div>
                    ) : (
                      <OrderTable orders={getActiveOrders()} />
                    )}
                  </TabsContent>

                  <TabsContent value="scheduled" className="mt-4">
                    {getScheduledOrders().length === 0 ? (
                      <div className="text-center py-8 text-[#848E9C] text-sm">
                        No scheduled orders.
                      </div>
                    ) : (
                      <OrderTable orders={getScheduledOrders()} />
                    )}
                  </TabsContent>

                  <TabsContent value="completed" className="mt-4">
                    {getCompletedOrders().length === 0 ? (
                      <div className="text-center py-8 text-[#848E9C] text-sm">
                        No completed orders.
                      </div>
                    ) : (
                      <OrderTable orders={getCompletedOrders()} />
                    )}
                  </TabsContent>
                </Tabs>
              )}
            </Card>
          </div>
        </div>
      </div>

      {/* Custom Scrollbar Styles */}
      <style>{`
        .custom-scrollbar::-webkit-scrollbar {
          width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
          background: #1E2329;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
          background: #2B3139;
          border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
          background: #F0B90B;
        }
        
        @media (max-width: 640px) {
          input, select, button {
            font-size: 16px !important;
          }
        }
      `}</style>
    </ErrorBoundary>
  );
}

// ==================== ERROR BOUNDARY COMPONENT ====================
class ErrorBoundary extends React.Component<{ children: React.ReactNode }, { hasError: boolean; error: any }> {
  constructor(props: { children: React.ReactNode }) {
    super(props);
    this.state = { hasError: false, error: null };
  }
  
  static getDerivedStateFromError(error: any) {
    return { hasError: true, error };
  }
  
  componentDidCatch(error: any, errorInfo: any) {
    console.error('Error caught by boundary:', error, errorInfo);
  }
  
  render() {
    if (this.state.hasError) {
      return (
        <div className="min-h-screen bg-[#181A20] flex items-center justify-center p-4">
          <div className="bg-red-900/20 text-red-200 rounded-lg border border-red-800 p-6 max-w-md">
            <div className="font-bold text-lg mb-3 flex items-center gap-2">
              <Shield size={20} />
              Something went wrong
            </div>
            <pre className="text-sm whitespace-pre-wrap opacity-80 mb-4">
              {this.state.error?.toString()}
            </pre>
            <Button 
              className="w-full bg-[#F0B90B] text-[#181A20] hover:bg-yellow-400"
              onClick={() => window.location.reload()}
            >
              Reload Page
            </Button>
          </div>
        </div>
      );
    }
    return this.props.children;
  }
}